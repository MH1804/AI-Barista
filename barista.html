<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home-Barista-Agent</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; }
        #chat { max-width: 600px; margin: 20px auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .message { margin-bottom: 10px; padding: 10px; border-radius: 5px; }
        .agent { background: #e0f7fa; }
        .user { background: #c8e6c9; text-align: right; }
        #input-area { display: flex; margin-top: 10px; }
        #user-input { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        #send-btn { padding: 10px 20px; background: #00796b; color: white; border: none; border-radius: 5px; cursor: pointer; }
        #image-upload { display: none; }
    </style>
</head>
<body>
    <div id="chat"></div>
    <div id="input-area">
        <input type="text" id="user-input" placeholder="Deine Antwort...">
        <button id="send-btn">Senden</button>
    </div>
    <input type="file" id="image-upload" accept="image/*">

    <script>
        // Konfiguration
        const ZIP_CODE = '10711';
        const LAT = 52.4958;
        const LON = 13.2871;
        const WEATHER_API_URL = 'https://api.openweathermap.org/data/2.5/weather';
        const WEATHER_API_KEY = 'DEIN_API_SCHLÜSSEL_HIER'; // Ersetze mit deinem OpenWeatherMap API-Schlüssel. Registriere dich kostenlos auf openweathermap.org

        // Lern-Gedächtnis
        let memory = JSON.parse(localStorage.getItem('baristaMemory')) || [];
        let currentState = 'ask_beansort';
        let currentData = {
            beansort: '',
            origin: '',
            process: '',
            roastlevel: '',
            roastdate: '',
            imageAnalysis: {},
            weather: {},
            recommendation: {}
        };

        const chat = document.getElementById('chat');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const imageUpload = document.getElementById('image-upload');

        function addMessage(text, sender) {
            const msg = document.createElement('div');
            msg.classList.add('message', sender);
            msg.textContent = text;
            chat.appendChild(msg);
            chat.scrollTop = chat.scrollHeight;
        }

        async function getWeather() {
            try {
                const response = await fetch(`${WEATHER_API_URL}?lat=${LAT}&lon=${LON}&appid=${WEATHER_API_KEY}&units=metric`);
                const data = await response.json();
                return {
                    temp: data.main.temp,
                    humidity: data.main.humidity,
                    pressure: data.main.pressure
                };
            } catch (error) {
                console.error('Wetterdaten-Fehler:', error);
                return { temp: 20, humidity: 50, pressure: 1013 }; // Fallback
            }
        }

        function analyzeImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        const data = ctx.getImageData(0, 0, img.width, img.height).data;
                        let r = 0, g = 0, b = 0;
                        for (let i = 0; i < data.length; i += 4) {
                            r += data[i];
                            g += data[i+1];
                            b += data[i+2];
                        }
                        const pixels = data.length / 4;
                        const avgR = r / pixels;
                        const avgG = g / pixels;
                        const avgB = b / pixels;
                        const brightness = (avgR + avgG + avgB) / 3;

                        let roast = 'medium';
                        if (brightness < 80) roast = 'dark';
                        else if (brightness > 140) roast = 'light';

                        // Simple Uniformität: Variance approximieren
                        let variance = 0;
                        for (let i = 0; i < data.length; i += 4) {
                            const br = (data[i] + data[i+1] + data[i+2]) / 3;
                            variance += Math.pow(br - brightness, 2);
                        }
                        variance /= pixels;
                        const uniform = variance < 500 ? 'hoch' : 'mittel';

                        resolve({
                            roast: roast,
                            surface: brightness < 100 ? 'ölig' : 'trocken',
                            uniformity: uniform
                        });
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        function calculateAge(roastdate) {
            const now = new Date();
            const roast = new Date(roastdate);
            return Math.floor((now - roast) / (1000 * 60 * 60 * 24));
        }

        function findSimilarBeans(beansort) {
            return memory.filter(shot => shot.beansort.toLowerCase().includes(beansort.toLowerCase()) && shot.success);
        }

        function adjustGrind(baseGrind, age, weather, imageAnalysis) {
            let grind = baseGrind;

            // Alter: Ältere Bohnen feiner (niedriger Wert)
            if (age > 30) grind -= 0.2;
            else if (age < 7) grind += 0.2;

            // Wetter
            if (weather.humidity > 60) grind += 0.2; // coarser
            if (weather.temp > 25) grind += 0.1; // coarser
            if (weather.temp < 15) grind -= 0.1; // finer
            if (weather.pressure < 1000) grind -= 0.1; // finer? Based on search

            // Bild
            if (imageAnalysis.roast === 'dark') grind += 0.1;
            if (imageAnalysis.roast === 'light') grind -= 0.1;
            if (imageAnalysis.uniformity === 'mittel') grind += 0.05;

            return Math.round(grind * 10) / 10; // Eine Dezimale
        }

        async function processState() {
            const weather = await getWeather();
            currentData.weather = weather;

            if (currentState === 'ask_beansort') {
                addMessage('Bitte nenne mir die Bohnensorte (Rösterei, Herkunft, Aufbereitung, Röstgrad).', 'agent');
            } else if (currentState === 'ask_image') {
                addMessage('Bitte lade ein aktuelles Bild der ganzen Bohnen hoch.', 'agent');
                imageUpload.style.display = 'block';
                imageUpload.onchange = async (e) => {
                    const file = e.target.files[0];
                    currentData.imageAnalysis = await analyzeImage(file);
                    addMessage('Bild hochgeladen und analysiert.', 'user');
                    imageUpload.style.display = 'none';
                    currentState = 'ask_roastdate';
                    processState();
                };
                return; // Warte auf Upload
            } else if (currentState === 'ask_roastdate') {
                addMessage('Bitte nenne mir das Röstdatum (YYYY-MM-DD).', 'agent');
            } else if (currentState === 'analyze') {
                const age = calculateAge(currentData.roastdate);
                const similar = findSimilarBeans(currentData.beansort);
                let baseGrind = 6.0;
                if (similar.length > 0) {
                    baseGrind = similar.reduce((sum, s) => sum + s.grind, 0) / similar.length;
                }
                const grind = adjustGrind(baseGrind, age, weather, currentData.imageAnalysis);

                // Fixed: Dose 15g, Ratio 1:2, Ziel 30g
                const dose = 15;
                const ratio = '1:2';
                const target = 30;

                currentData.recommendation = { dose, target, ratio, grind };

                addMessage(`Empfehlung:\n- Dosis: ${dose} g\n- Zielgetränk: ${target} g\n- Brühverhältnis: ${ratio}\n- Mahlgrad: ${grind}\nBegründung: Basierend auf Bohnenalter (${age} Tage), Wetter (Temp: ${weather.temp}°C, Feuchtigkeit: ${weather.humidity}%), Bildanalyse (Röstgrad: ${currentData.imageAnalysis.roast}, Uniformität: ${currentData.imageAnalysis.uniformity}) und Referenzen.`, 'agent');

                currentState = 'ask_feedback';
                addMessage('Bitte gib Feedback zum Shot: Input (g), Output (g), Durchlaufzeit (s), Geschmack (sauer/ausgewogen/bitter), Fluss (zu schnell/gleichmäßig/stockend). Trenne mit Kommas.', 'agent');
            } else if (currentState === 'process_feedback') {
                // Speichere in Memory
                memory.push({ ...currentData, success: currentData.feedback.taste === 'ausgewogen' });
                localStorage.setItem('baristaMemory', JSON.stringify(memory));

                // Nächster Shot? Oder neu starten
                addMessage('Danke für das Feedback. Möchtest du einen neuen Shot optimieren? (ja/nein)', 'agent');
                currentState = 'restart';
            } else if (currentState === 'restart') {
                if (userInput.value.toLowerCase() === 'ja') {
                    currentData = {};
                    currentState = 'ask_beansort';
                    processState();
                } else {
                    addMessage('Vielen Dank. Bis zum nächsten Mal.', 'agent');
                }
            }
        }

        sendBtn.onclick = () => {
            const text = userInput.value.trim();
            if (!text) return;
            addMessage(text, 'user');
            userInput.value = '';

            if (currentState === 'ask_beansort') {
                currentData.beansort = text; // Einfach als String speichern
                currentState = 'ask_image';
            } else if (currentState === 'ask_roastdate') {
                currentData.roastdate = text;
                currentState = 'analyze';
            } else if (currentState === 'ask_feedback') {
                const [input, output, time, taste, flow] = text.split(',').map(s => s.trim());
                currentData.feedback = { input, output, time, taste, flow };
                currentState = 'process_feedback';
            } else if (currentState === 'restart') {
                // Handled in processState
            }
            processState();
        };

        // Start
        processState();
    </script>
</body>
</html>