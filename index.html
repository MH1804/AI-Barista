<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barista Companion</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f5f5dc; /* beige */ color: #4b3832; /* dark brown */ }
        #chat { max-width: 600px; margin: 20px auto; background: #e3d5ca; /* light brown */ padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .message { margin-bottom: 10px; padding: 10px; border-radius: 5px; }
        .agent { background: #d2b48c; /* tan */ }
        .user { background: #8b4513; /* saddlebrown */ color: white; text-align: right; }
        #input-area { display: flex; margin-top: 10px; }
        #user-input { flex: 1; padding: 10px; border: 1px solid #a0522d; /* sienna */ border-radius: 5px; }
        #send-btn { padding: 10px 20px; background: #8b4513; color: white; border: none; border-radius: 5px; cursor: pointer; }
        #image-upload, #date-input { display: none; }
        #history-btn { padding: 10px; background: #a0522d; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 10px auto; display: block; }
        #history { max-width: 600px; margin: 20px auto; background: #e3d5ca; padding: 20px; border-radius: 8px; display: none; }
        h1 { text-align: center; color: #4b3832; }
    </style>
</head>
<body>
    <h1>Barista Companion</h1>
    <div id="chat"></div>
    <div id="input-area">
        <input type="text" id="user-input" placeholder="Deine Antwort...">
        <button id="send-btn">Senden</button>
    </div>
    <input type="file" id="image-upload" accept="image/*">
    <input type="date" id="date-input">
    <button id="history-btn">Shot-Historie anzeigen</button>
    <div id="history"></div>

    <script>
        // Konfiguration
        const ZIP_CODE = '10711';
        const LAT = 52.4958;
        const LON = 13.2871;
        const WEATHER_API_URL = 'https://api.openweathermap.org/data/2.5/weather';
        const WEATHER_API_KEY = 'DEIN_OPENWEATHER_API_SCHLÜSSEL_HIER'; // Ersetze mit deinem OpenWeatherMap API-Schlüssel
        const OPENAI_API_KEY = 'DEIN_OPENAI_API_SCHLÜSSEL_HIER'; // Ersetze mit deinem OpenAI API-Schlüssel (für GPT-4o oder Vision-Modell)

        // Lern-Gedächtnis und Speicher
        let shots = JSON.parse(localStorage.getItem('shots')) || [];
        let roasteries = JSON.parse(localStorage.getItem('roasteries')) || ['Beispiel Rösterei 1', 'Beispiel Rösterei 2'];
        let origins = JSON.parse(localStorage.getItem('origins')) || ['Äthiopien', 'Kolumbien'];
        let processes = JSON.parse(localStorage.getItem('processes')) || ['Washed', 'Natural'];
        let roastlevels = JSON.parse(localStorage.getItem('roastlevels')) || ['Light', 'Medium', 'Dark'];

        let currentState = 'ask_roastery';
        let currentData = {
            roastery: '',
            origin: '',
            process: '',
            roastlevel: '',
            roastdate: '',
            imageAnalysis: {},
            weather: {},
            recommendation: {},
            feedback: {}
        };

        const chat = document.getElementById('chat');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const imageUpload = document.getElementById('image-upload');
        const dateInput = document.getElementById('date-input');
        const historyBtn = document.getElementById('history-btn');
        const historyDiv = document.getElementById('history');

        function addMessage(text, sender) {
            const msg = document.createElement('div');
            msg.classList.add('message', sender);
            msg.innerHTML = text; // Für HTML erlauben
            chat.appendChild(msg);
            chat.scrollTop = chat.scrollHeight;
        }

        function updateDatalist(id, options) {
            const datalist = document.getElementById(id);
            datalist.innerHTML = '';
            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                datalist.appendChild(option);
            });
        }

        async function getWeather() {
            try {
                const response = await fetch(`${WEATHER_API_URL}?lat=${LAT}&lon=${LON}&appid=${WEATHER_API_KEY}&units=metric`);
                const data = await response.json();
                return {
                    temp: data.main.temp,
                    humidity: data.main.humidity,
                    pressure: data.main.pressure
                };
            } catch (error) {
                console.error('Wetterdaten-Fehler:', error);
                return { temp: 20, humidity: 50, pressure: 1013 }; // Fallback
            }
        }

        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        async function analyzeImage(file) {
            if (!OPENAI_API_KEY || OPENAI_API_KEY === 'DEIN_OPENAI_API_SCHLÜSSEL_HIER') {
                throw new Error('OpenAI API-Schlüssel fehlt.');
            }
            const base64 = await toBase64(file);
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${OPENAI_API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o',
                        messages: [{
                            role: 'user',
                            content: [
                                { type: 'text', text: 'Analysiere das Röstgrad (light, medium, dark), Oberfläche (oily, dry), Uniformität (high, medium, low) dieser Kaffeebohnen. Antworte im JSON-Format: {"roast": "medium", "surface": "dry", "uniformity": "high"}' },
                                { type: 'image_url', image_url: { url: `data:image/jpeg;base64,${base64}` } }
                            ]
                        }],
                        max_tokens: 100
                    })
                });
                const data = await response.json();
                const content = data.choices[0].message.content;
                return JSON.parse(content.replace(/```json|```/g, '').trim());
            } catch (error) {
                console.error('KI-Analyse-Fehler:', error);
                return { roast: 'medium', surface: 'dry', uniformity: 'high' }; // Fallback
            }
        }

        function calculateAge(roastdate) {
            const now = new Date();
            const roast = new Date(roastdate);
            return Math.floor((now - roast) / (1000 * 60 * 60 * 24));
        }

        function findSimilarBeans(roastery, origin, process, roastlevel) {
            return shots.filter(shot => 
                shot.roastery === roastery && 
                shot.origin === origin && 
                shot.process === process && 
                shot.roastlevel === roastlevel && 
                shot.feedback && shot.feedback.taste === 'ausgewogen'
            );
        }

        function adjustGrind(baseGrind, age, weather, imageAnalysis) {
            let grind = baseGrind;

            if (age > 30) grind -= 0.2;
            else if (age < 7) grind += 0.2;

            if (weather.humidity > 60) grind += 0.2;
            if (weather.temp > 25) grind += 0.1;
            if (weather.temp < 15) grind -= 0.1;
            if (weather.pressure < 1000) grind -= 0.1;

            if (imageAnalysis.roast === 'dark') grind += 0.1;
            if (imageAnalysis.roast === 'light') grind -= 0.1;
            if (imageAnalysis.uniformity === 'medium' || imageAnalysis.uniformity === 'low') grind += 0.05;

            return Math.round(grind * 10) / 10;
        }

        function saveUniqueValue(array, value, key) {
            if (value && !array.includes(value)) {
                array.push(value);
                localStorage.setItem(key, JSON.stringify(array));
            }
        }

        function showHistory() {
            historyDiv.innerHTML = '<h2>Shot-Historie</h2>';
            if (shots.length === 0) {
                historyDiv.innerHTML += '<p>Keine Shots gespeichert.</p>';
            } else {
                shots.forEach((shot, index) => {
                    const shotDiv = document.createElement('div');
                    shotDiv.innerHTML = `<strong>Shot ${index + 1}</strong><br>
                    Rösterei: ${shot.roastery}<br>
                    Herkunft: ${shot.origin}<br>
                    Aufbereitung: ${shot.process}<br>
                    Röstgrad: ${shot.roastlevel}<br>
                    Röstdatum: ${shot.roastdate}<br>
                    Bildanalyse: ${JSON.stringify(shot.imageAnalysis)}<br>
                    Wetter: ${JSON.stringify(shot.weather)}<br>
                    Empfehlung: ${JSON.stringify(shot.recommendation)}<br>
                    Feedback: ${JSON.stringify(shot.feedback)}<br><hr>`;
                    historyDiv.appendChild(shotDiv);
                });
            }
            historyDiv.style.display = 'block';
        }

        async function processState() {
            if (currentState === 'ask_roastery') {
                addMessage('Bitte wähle oder gib die Rösterei ein.', 'agent');
                addMessage('<input type="text" id="roastery-input" list="roasteries-list" placeholder="Rösterei...">', 'agent');
                updateDatalist('roasteries-list', roasteries);
            } else if (currentState === 'ask_origin') {
                addMessage('Bitte wähle oder gib die Herkunft ein.', 'agent');
                addMessage('<input type="text" id="origin-input" list="origins-list" placeholder="Herkunft...">', 'agent');
                updateDatalist('origins-list', origins);
            } else if (currentState === 'ask_process') {
                addMessage('Bitte wähle oder gib die Aufbereitung ein.', 'agent');
                addMessage('<input type="text" id="process-input" list="processes-list" placeholder="Aufbereitung...">', 'agent');
                updateDatalist('processes-list', processes);
            } else if (currentState === 'ask_roastlevel') {
                addMessage('Bitte wähle oder gib den Röstgrad ein.', 'agent');
                addMessage('<input type="text" id="roastlevel-input" list="roastlevels-list" placeholder="Röstgrad...">', 'agent');
                updateDatalist('roastlevels-list', roastlevels);
            } else if (currentState === 'ask_image') {
                addMessage('Bitte lade ein aktuelles Bild der ganzen Bohnen hoch.', 'agent');
                imageUpload.style.display = 'block';
                imageUpload.onchange = async (e) => {
                    const file = e.target.files[0];
                    try {
                        currentData.imageAnalysis = await analyzeImage(file);
                        addMessage('Bild hochgeladen und mit KI analysiert.', 'user');
                    } catch (error) {
                        addMessage('Fehler bei der KI-Analyse. Fallback verwendet.', 'agent');
                        currentData.imageAnalysis = { roast: 'medium', surface: 'dry', uniformity: 'high' };
                    }
                    imageUpload.style.display = 'none';
                    currentState = 'ask_roastdate';
                    processState();
                };
                return;
            } else if (currentState === 'ask_roastdate') {
                addMessage('Bitte wähle das Röstdatum.', 'agent');
                dateInput.style.display = 'block';
                dateInput.onchange = (e) => {
                    currentData.roastdate = e.target.value;
                    addMessage(`Röstdatum: ${currentData.roastdate}`, 'user');
                    dateInput.style.display = 'none';
                    currentState = 'analyze';
                    processState();
                };
                return;
            } else if (currentState === 'analyze') {
                const weather = await getWeather();
                currentData.weather = weather;
                const age = calculateAge(currentData.roastdate);
                const similar = findSimilarBeans(currentData.roastery, currentData.origin, currentData.process, currentData.roastlevel);
                let baseGrind = 6.0;
                if (similar.length > 0) {
                    baseGrind = similar.reduce((sum, s) => sum + s.recommendation.grind, 0) / similar.length;
                }
                const grind = adjustGrind(baseGrind, age, weather, currentData.imageAnalysis);

                const dose = 15;
                const ratio = '1:2';
                const target = 30;

                currentData.recommendation = { dose, target, ratio, grind };

                addMessage(`Empfehlung:<br>- Dosis: ${dose} g<br>- Zielgetränk: ${target} g<br>- Brühverhältnis: ${ratio}<br>- Mahlgrad: ${grind}<br>Begründung: Basierend auf Bohnenalter (${age} Tage), Wetter (Temp: ${weather.temp}°C, Feuchtigkeit: ${weather.humidity}%), KI-Bildanalyse (Röstgrad: ${currentData.imageAnalysis.roast}, Oberfläche: ${currentData.imageAnalysis.surface}, Uniformität: ${currentData.imageAnalysis.uniformity}) und Referenzen.`, 'agent');

                currentState = 'ask_feedback';
                addMessage('Bitte gib Feedback zum Shot: Input (g), Output (g), Durchlaufzeit (s), Geschmack (sauer/ausgewogen/bitter), Fluss (zu schnell/gleichmäßig/stockend). Trenne mit Kommas.', 'agent');
            } else if (currentState === 'process_feedback') {
                shots.push({ ...currentData });
                localStorage.setItem('shots', JSON.stringify(shots));

                addMessage('Danke für das Feedback. Shot gespeichert. Möchtest du einen neuen Shot optimieren? (ja/nein)', 'agent');
                currentState = 'restart';
            } else if (currentState === 'restart') {
                if (userInput.value.toLowerCase() === 'ja') {
                    currentData = { roastery: '', origin: '', process: '', roastlevel: '', roastdate: '', imageAnalysis: {}, weather: {}, recommendation: {}, feedback: {} };
                    currentState = 'ask_roastery';
                    processState();
                } else {
                    addMessage('Vielen Dank. Bis zum nächsten Mal.', 'agent');
                }
            }
        }

        sendBtn.onclick = () => {
            const text = userInput.value.trim();
            if (!text) return;
            addMessage(text, 'user');
            userInput.value = '';

            if (currentState === 'ask_roastery') {
                currentData.roastery = text;
                saveUniqueValue(roasteries, text, 'roasteries');
                currentState = 'ask_origin';
            } else if (currentState === 'ask_origin') {
                currentData.origin = text;
                saveUniqueValue(origins, text, 'origins');
                currentState = 'ask_process';
            } else if (currentState === 'ask_process') {
                currentData.process = text;
                saveUniqueValue(processes, text, 'processes');
                currentState = 'ask_roastlevel';
            } else if (currentState === 'ask_roastlevel') {
                currentData.roastlevel = text;
                saveUniqueValue(roastlevels, text, 'roastlevels');
                currentState = 'ask_image';
            } else if (currentState === 'ask_feedback') {
                const [input, output, time, taste, flow] = text.split(',').map(s => s.trim());
                currentData.feedback = { input, output, time, taste, flow };
                currentState = 'process_feedback';
            } else if (currentState === 'restart') {
                // Handled above
            }
            processState();
        };

        historyBtn.onclick = () => {
            if (historyDiv.style.display === 'none') {
                showHistory();
                historyBtn.textContent = 'Historie ausblenden';
            } else {
                historyDiv.style.display = 'none';
                historyBtn.textContent = 'Shot-Historie anzeigen';
            }
        };

        // Datalists erstellen
        ['roasteries-list', 'origins-list', 'processes-list', 'roastlevels-list'].forEach(id => {
            const dl = document.createElement('datalist');
            dl.id = id;
            document.body.appendChild(dl);
        });

        // Start
        processState();
    </script>
</body>
</html>
